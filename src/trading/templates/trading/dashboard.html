{% extends 'trading/base.html' %}
{% load trading_extras %}

{% block title %}Dashboard - FKS Trading{% endblock %}
{% block page_title %}<i class="bi bi-speedometer2"></i> Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Live Prices -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Live Prices
                <button class="btn btn-sm btn-primary float-end" onclick="refreshPrices()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="row" id="price-container">
                    {% for symbol in symbols %}
                    <div class="col-md-2 col-sm-4 col-6 mb-3 text-center">
                        <div class="price-card">
                            <div class="text-muted small">{{ symbol }}</div>
                            <div class="price-badge bg-light" id="price-{{ symbol }}">
                                {% if live_prices and symbol in live_prices %}
                                    ${{ live_prices|get_item:symbol|floatformat:2 }}
                                {% else %}
                                    <span class="loading"></span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="col-md-3 col-sm-6">
        <div class="stat-card">
            <div class="stat-value">{{ total_trades }}</div>
            <div class="stat-label">
                <i class="bi bi-bar-chart"></i> Total Trades
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6">
        <div class="stat-card {% if total_pnl >= 0 %}success{% else %}danger{% endif %}">
            <div class="stat-value">${{ total_pnl|floatformat:2 }}</div>
            <div class="stat-label">
                <i class="bi bi-wallet2"></i> Total P&L
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6">
        <div class="stat-card warning">
            <div class="stat-value">{{ open_positions.count }}</div>
            <div class="stat-label">
                <i class="bi bi-briefcase"></i> Open Positions
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6">
        <div class="stat-card {% if win_rate >= 50 %}success{% else %}danger{% endif %}">
            <div class="stat-value">{{ win_rate|floatformat:1 }}%</div>
            <div class="stat-label">
                <i class="bi bi-trophy"></i> Win Rate
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Actions -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning-charge"></i> Quick Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if not has_cached_data %}
                    <a href="{% url 'trading:data_pull' %}" class="btn btn-primary btn-custom">
                        <i class="bi bi-download"></i> Pull Historical Data
                    </a>
                    {% elif not has_best_params %}
                    <a href="{% url 'trading:optimization' %}" class="btn btn-info btn-custom">
                        <i class="bi bi-graph-up"></i> Run Optimization
                    </a>
                    {% else %}
                    <a href="{% url 'trading:signals' %}" class="btn btn-success btn-custom">
                        <i class="bi bi-bullseye"></i> Generate Signal
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'trading:trades' %}" class="btn btn-outline-primary btn-custom">
                        <i class="bi bi-bar-chart-line"></i> View Trades
                    </a>
                    <a href="{% url 'trading:positions' %}" class="btn btn-outline-info btn-custom">
                        <i class="bi bi-wallet2"></i> View Positions
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Signals -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bullseye"></i> Recent Signals
                <a href="{% url 'trading:signals' %}" class="btn btn-sm btn-outline-primary float-end">View All</a>
            </div>
            <div class="card-body">
                {% if recent_signals %}
                <div class="list-group list-group-flush">
                    {% for signal in recent_signals|slice:":5" %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between">
                            <span>
                                <span class="badge bg-{% if signal.signal_type == 'buy' %}success{% else %}secondary{% endif %}">
                                    {{ signal.signal_type|upper }}
                                </span>
                                <small class="text-muted ms-2">
                                    Confidence: {{ signal.confidence|floatformat:2 }}
                                </small>
                            </span>
                            <small class="text-muted">{{ signal.created_at|timesince }} ago</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">
                    <i class="bi bi-info-circle"></i> No signals generated yet
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Trades -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart-line"></i> Recent Trades
                <a href="{% url 'trading:trades' %}" class="btn btn-sm btn-outline-primary float-end">View All</a>
            </div>
            <div class="card-body">
                {% if recent_trades %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Quantity</th>
                                <th>Entry Price</th>
                                <th>Exit Price</th>
                                <th>P&L</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in recent_trades %}
                            <tr>
                                <td><strong>{{ trade.symbol }}</strong></td>
                                <td>
                                    <span class="badge bg-{% if trade.side == 'long' %}success{% else %}danger{% endif %}">
                                        {{ trade.side|upper }}
                                    </span>
                                </td>
                                <td>{{ trade.quantity|floatformat:6 }}</td>
                                <td>${{ trade.entry_price|floatformat:2 }}</td>
                                <td>
                                    {% if trade.exit_price %}
                                        ${{ trade.exit_price|floatformat:2 }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if trade.pnl %}
                                        <span class="{% if trade.pnl >= 0 %}positive{% else %}negative{% endif %}">
                                            ${{ trade.pnl|floatformat:2 }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{% if trade.status == 'open' %}warning{% elif trade.status == 'closed' %}success{% else %}secondary{% endif %}">
                                        {{ trade.status|upper }}
                                    </span>
                                </td>
                                <td>{{ trade.entry_time|date:"M d, Y H:i" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">
                    <i class="bi bi-info-circle"></i> No trades recorded yet
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Refresh live prices
    async function refreshPrices() {
        try {
            const response = await fetch('{% url "trading:api_live_prices" %}');
            const data = await response.json();
            
            if (data.success) {
                for (const [symbol, price] of Object.entries(data.prices)) {
                    const element = document.getElementById(`price-${symbol}`);
                    if (element) {
                        element.textContent = formatPrice(price);
                        element.classList.add('bg-success', 'text-white');
                        setTimeout(() => {
                            element.classList.remove('bg-success', 'text-white');
                            element.classList.add('bg-light');
                        }, 1000);
                    }
                }
            }
        } catch (error) {
            console.error('Error refreshing prices:', error);
        }
    }
    
    // Auto-refresh prices every 30 seconds
    setInterval(refreshPrices, 30000);
    
    // Initial load
    window.addEventListener('load', refreshPrices);
</script>
{% endblock %}
