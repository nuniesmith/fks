{% extends 'trading/base.html' %}

{% block title %}Optimization - FKS Trading{% endblock %}
{% block page_title %}<i class="bi bi-graph-up"></i> Strategy Optimization{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        {% if not has_cached_data %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> 
            <strong>No cached data found.</strong> 
            Please <a href="{% url 'trading:data_pull' %}" class="alert-link">pull historical data</a> first.
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <i class="bi bi-cpu"></i> Run Optuna Optimization
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Use Optuna to find optimal strategy parameters across all symbols.
                    This process runs multiple backtests to maximize the Sharpe ratio.
                </p>
                
                <form method="post" id="optimization-form">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="n_trials" class="form-label">
                                    <i class="bi bi-arrow-repeat"></i> Number of Trials
                                </label>
                                <input type="number" class="form-control" id="n_trials" name="n_trials" 
                                       value="50" min="10" max="500" step="10" required>
                                <small class="form-text text-muted">
                                    More trials = better optimization but slower (10-500)
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="symbol" class="form-label">
                                    <i class="bi bi-coin"></i> Symbol
                                </label>
                                <select class="form-select" id="symbol" name="symbol" required>
                                    {% for symbol in symbols %}
                                    <option value="{{ symbol }}">{{ symbol }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Symbol to optimize (will apply to all in backtest)
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Optimization Search Space:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>RSI Period:</strong> 10-20</li>
                            <li><strong>RSI Oversold:</strong> 20-35</li>
                            <li><strong>RSI Overbought:</strong> 65-80</li>
                            <li><strong>ATR Period:</strong> 10-20</li>
                            <li><strong>ATR Multiplier:</strong> 1.0-3.0</li>
                            <li><strong>SMA Period:</strong> 50-200</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg btn-custom" 
                                id="optimize-btn" {% if not has_cached_data %}disabled{% endif %}>
                            <i class="bi bi-play-fill"></i> Start Optimization
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if best_params %}
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <i class="bi bi-trophy"></i> Best Parameters Found
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>RSI Period:</strong></td>
                                    <td>{{ best_params.rsi_period }}</td>
                                </tr>
                                <tr>
                                    <td><strong>RSI Oversold:</strong></td>
                                    <td>{{ best_params.rsi_oversold }}</td>
                                </tr>
                                <tr>
                                    <td><strong>RSI Overbought:</strong></td>
                                    <td>{{ best_params.rsi_overbought }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>ATR Period:</strong></td>
                                    <td>{{ best_params.atr_period }}</td>
                                </tr>
                                <tr>
                                    <td><strong>ATR Multiplier:</strong></td>
                                    <td>{{ best_params.atr_multiplier|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td><strong>SMA Period:</strong></td>
                                    <td>{{ best_params.sma_period }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                {% if backtest_results %}
                <hr>
                <h5 class="mb-3">Backtest Results (All Symbols)</h5>
                <div class="row">
                    {% for result in backtest_results %}
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <strong>{{ result.symbol }}</strong>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="stat-card {% if result.total_return > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                            <div class="stat-value">{{ result.total_return|floatformat:2 }}%</div>
                                            <div class="stat-label">Total Return</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card bg-primary">
                                            <div class="stat-value">{{ result.sharpe_ratio|floatformat:2 }}</div>
                                            <div class="stat-label">Sharpe Ratio</div>
                                        </div>
                                    </div>
                                </div>
                                <table class="table table-sm mt-3 mb-0">
                                    <tbody>
                                        <tr>
                                            <td>Trades:</td>
                                            <td class="text-end">{{ result.num_trades }}</td>
                                        </tr>
                                        <tr>
                                            <td>Win Rate:</td>
                                            <td class="text-end">{{ result.win_rate|floatformat:1 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Max Drawdown:</td>
                                            <td class="text-end text-danger">{{ result.max_drawdown|floatformat:2 }}%</td>
                                        </tr>
                                        <tr>
                                            <td>Sortino Ratio:</td>
                                            <td class="text-end">{{ result.sortino_ratio|floatformat:2 }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <!-- Optimization results are preview only, not saved to database -->
                                <div class="text-muted small mt-2 text-center">
                                    <i class="bi bi-info-circle"></i> Optimization preview results
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="d-grid gap-2 mt-3">
                    <a href="{% url 'trading:signals' %}" class="btn btn-success btn-custom">
                        <i class="bi bi-lightning"></i> Continue to Signal Generation
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> About Optimization
            </div>
            <div class="card-body">
                <h6>How it Works:</h6>
                <ul>
                    <li>Optuna uses TPE (Tree-structured Parzen Estimator) sampler</li>
                    <li>Objective: Maximize Sharpe ratio across all symbols</li>
                    <li>Each trial runs a full backtest with different parameters</li>
                    <li>Best parameters are saved in session for signal generation</li>
                </ul>
                
                <h6 class="mt-3">Performance Tips:</h6>
                <ul class="mb-0">
                    <li><strong>Quick Test:</strong> 10-20 trials (~30 seconds)</li>
                    <li><strong>Balanced:</strong> 50-100 trials (~2-3 minutes)</li>
                    <li><strong>Thorough:</strong> 200-500 trials (~10-20 minutes)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('optimization-form').addEventListener('submit', function(e) {
        const btn = document.getElementById('optimize-btn');
        const trials = document.getElementById('n_trials').value;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Running optimization... (0/' + trials + ')';
        
        // Optional: Could add progress polling here
    });
</script>
{% endblock %}
