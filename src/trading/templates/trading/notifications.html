{% extends 'trading/base.html' %}

{% block title %}Notifications - FKS Trading{% endblock %}
{% block page_title %}<i class="bi bi-bell"></i> Discord Notifications{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-discord"></i> Discord Webhook Configuration
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Configure Discord webhook to receive trade notifications and alerts.
                    Notifications will be sent for signals, trade executions, and position updates.
                </p>
                
                <form method="post" id="webhook-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="webhook_url" class="form-label">
                            <i class="bi bi-link-45deg"></i> Webhook URL
                        </label>
                        <input type="url" class="form-control" id="webhook_url" 
                               name="webhook_url" value="{{ webhook_url }}" 
                               placeholder="https://discord.com/api/webhooks/..." required>
                        <small class="form-text text-muted">
                            Your Discord webhook URL. Get it from Server Settings ‚Üí Integrations ‚Üí Webhooks.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-toggles"></i> Notification Settings
                        </label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify_signals" 
                                   name="notify_signals" {% if notify_signals %}checked{% endif %}>
                            <label class="form-check-label" for="notify_signals">
                                Trading Signals (BUY/SELL alerts)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify_trades" 
                                   name="notify_trades" {% if notify_trades %}checked{% endif %}>
                            <label class="form-check-label" for="notify_trades">
                                Trade Executions (entries and exits)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify_positions" 
                                   name="notify_positions" {% if notify_positions %}checked{% endif %}>
                            <label class="form-check-label" for="notify_positions">
                                Position Updates (P&L changes, stop loss/take profit triggers)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify_errors" 
                                   name="notify_errors" {% if notify_errors %}checked{% endif %}>
                            <label class="form-check-label" for="notify_errors">
                                Errors and Warnings
                            </label>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-custom">
                            <i class="bi bi-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Test Notification -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-send"></i> Test Notification
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Send a test message to verify your webhook is configured correctly.
                </p>
                
                <form method="post" action="{% url 'trading:test_notification' %}" id="test-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="test_message" class="form-label">Test Message</label>
                        <textarea class="form-control" id="test_message" name="message" 
                                  rows="3" required>ü§ñ Test notification from FKS Trading Bot

This is a test message to verify your Discord webhook is working correctly.</textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-custom" id="test-btn">
                            <i class="bi bi-send-fill"></i> Send Test Notification
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Recent Notifications -->
        {% if recent_notifications %}
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Recent Notifications
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Message</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for notif in recent_notifications %}
                            <tr>
                                <td>{{ notif.timestamp|date:"Y-m-d H:i:s" }}</td>
                                <td>
                                    <span class="badge bg-{{ notif.type_color }}">
                                        {{ notif.type }}
                                    </span>
                                </td>
                                <td>{{ notif.message|truncatewords:15 }}</td>
                                <td>
                                    {% if notif.success %}
                                    <span class="text-success">
                                        <i class="bi bi-check-circle"></i> Sent
                                    </span>
                                    {% else %}
                                    <span class="text-danger">
                                        <i class="bi bi-x-circle"></i> Failed
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Setup Instructions
            </div>
            <div class="card-body">
                <h6>How to Create a Discord Webhook:</h6>
                <ol>
                    <li>Go to your Discord server</li>
                    <li>Click on Server Settings (gear icon)</li>
                    <li>Navigate to Integrations ‚Üí Webhooks</li>
                    <li>Click "New Webhook" or "Create Webhook"</li>
                    <li>Give it a name (e.g., "FKS Trading Bot")</li>
                    <li>Select the channel where you want notifications</li>
                    <li>Click "Copy Webhook URL"</li>
                    <li>Paste the URL in the field above</li>
                </ol>
                
                <h6 class="mt-3">Notification Examples:</h6>
                <div class="alert alert-success mb-2">
                    <strong>üîî Trading Signal</strong><br>
                    <small>BUY BTCUSDT @ $45,000 | Size: 0.1 BTC | Stop: $44,000 | Target: $47,000</small>
                </div>
                <div class="alert alert-primary mb-2">
                    <strong>‚úÖ Trade Executed</strong><br>
                    <small>Bought 0.1 BTCUSDT @ $45,000 | Total: $4,500</small>
                </div>
                <div class="alert alert-warning mb-2">
                    <strong>‚ö†Ô∏è Position Update</strong><br>
                    <small>BTCUSDT: +5.2% ($2,340) | Stop loss triggered!</small>
                </div>
                <div class="alert alert-danger mb-0">
                    <strong>‚ùå Error</strong><br>
                    <small>Failed to fetch price data for ETHUSDT</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('webhook-form').addEventListener('submit', function(e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Saving...';
    });
    
    document.getElementById('test-form').addEventListener('submit', function(e) {
        const btn = document.getElementById('test-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Sending...';
    });
</script>
{% endblock %}
