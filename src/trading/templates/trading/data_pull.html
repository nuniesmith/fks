{% extends 'trading/base.html' %}

{% block title %}Data Pull - FKS Trading{% endblock %}
{% block page_title %}<i class="bi bi-download"></i> Pull Historical Data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-database"></i> Fetch Historical OHLCV Data
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Pull historical price data from Binance API for all configured symbols.
                    Data will be cached for 1 hour.
                </p>
                
                <form method="post" id="data-pull-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="interval" class="form-label">
                            <i class="bi bi-clock"></i> Interval
                        </label>
                        <select class="form-select" id="interval" name="interval" required>
                            {% for interval in intervals %}
                            <option value="{{ interval }}" {% if interval == '1d' %}selected{% endif %}>
                                {{ interval }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Candle interval (1h = hourly, 4h = 4-hour, 1d = daily)
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="limit" class="form-label">
                            <i class="bi bi-calendar-range"></i> Number of Periods
                        </label>
                        <input type="number" class="form-control" id="limit" name="limit" 
                               value="1000" min="100" max="2000" step="100" required>
                        <small class="form-text text-muted">
                            Number of candles to fetch (100-2000). Recommendation: 1000 for daily data.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-coin"></i> Symbols
                        </label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for symbol in symbols %}
                            <span class="badge bg-primary">{{ symbol }}</span>
                            {% endfor %}
                        </div>
                        <small class="form-text text-muted">
                            Configured symbols ({{ symbols|length }} total)
                        </small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg btn-custom" id="pull-btn">
                            <i class="bi bi-download"></i> Pull Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if has_cached_data %}
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <i class="bi bi-check-circle"></i> Cached Data Available
            </div>
            <div class="card-body">
                {% if data_info %}
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Periods:</strong> {{ data_info.num_periods }}</p>
                        <p><strong>Start Date:</strong> {{ data_info.start_date }}</p>
                        <p><strong>End Date:</strong> {{ data_info.end_date }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Symbols:</strong> {{ data_info.symbols|length }}</p>
                        <div class="d-flex flex-wrap gap-1">
                            {% for symbol in data_info.symbols %}
                            <span class="badge bg-secondary">{{ symbol }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-3">
                    <a href="{% url 'trading:optimization' %}" class="btn btn-success btn-custom">
                        <i class="bi bi-graph-up"></i> Continue to Optimization
                    </a>
                </div>
                {% else %}
                <p class="mb-0">Data is cached and ready for use.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Help & Tips
            </div>
            <div class="card-body">
                <h6>Data Quality Checks:</h6>
                <ul>
                    <li>Minimum 100 periods required for backtesting</li>
                    <li>Data is automatically aligned across all symbols</li>
                    <li>NaN values and non-positive prices are detected</li>
                    <li>Cache expires after 1 hour</li>
                </ul>
                
                <h6 class="mt-3">Recommended Settings:</h6>
                <ul class="mb-0">
                    <li><strong>For Backtesting:</strong> 1d interval, 1000+ periods</li>
                    <li><strong>For Intraday:</strong> 1h or 4h interval, 500-1000 periods</li>
                    <li><strong>For Quick Tests:</strong> 1d interval, 100-200 periods</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('data-pull-form').addEventListener('submit', function(e) {
        const btn = document.getElementById('pull-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Pulling data...';
    });
    
    // Calculate estimated date range
    document.getElementById('limit').addEventListener('change', function() {
        const interval = document.getElementById('interval').value;
        const limit = parseInt(this.value);
        
        let daysBack = 0;
        if (interval === '1d') daysBack = limit;
        else if (interval === '4h') daysBack = Math.floor(limit * 4 / 24);
        else if (interval === '1h') daysBack = Math.floor(limit / 24);
        
        if (daysBack > 0) {
            const date = new Date();
            date.setDate(date.getDate() - daysBack);
            console.log(`Estimated start date: ${date.toDateString()}`);
        }
    });
</script>
{% endblock %}
